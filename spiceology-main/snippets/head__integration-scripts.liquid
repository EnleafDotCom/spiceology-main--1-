{% unless settings.gtag_id == blank %}
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ settings.gtag_id }}"></script>
  {% comment %}
    https://developers.google.com/analytics/devguides/collection/ga4/ecommerce?client_type=gtag
  {% endcomment %}
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag(
      'config',
      '{{ settings.gtag_id }}'
      {% if customer %}
        , {
          'user_id': '{{ customer.id }}'
        }
      {% endif %}
    );

    {% if product %}
      gtag("event", "view_item", {
        value: {{ product.selected_or_first_available_variant.price | divided_by: 100 }},
        currency: CURRENCY,
        items: [{
          item_id: {{ product.id | json }},
          item_name: {{ product.title | json }},
          item_variant: {{ product.selected_or_first_available_variant.title | json }},
          price: {{ product.selected_or_first_available_variant.price | divided_by: 100 }},
          quantity: 1
        }]
      });
    {% endif %}
  </script>
{% endunless %}


{% unless settings.gtm_id == blank %}
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','{{ settings.gtm_id }}');</script>
  <!-- End Google Tag Manager -->

  <script>
    window.dataLayer = window.dataLayer || []

    {% if customer %}
      window.dataLayer.push({
        user_id: '{{ customer.id }}',
      })
    {% endif %}

    {% if product %}
      window.dataLayer.push({ ecommerce: null });
      window.dataLayer.push({
        event: "view_item",
        ecommerce: {
          value: {{ product.selected_or_first_available_variant.price | divided_by: 100 }},
          currency: CURRENCY,
          items: [{
            item_id: {{ product.id | json }},
            item_name: {{ product.title | json }},
            item_variant: {{ product.selected_or_first_available_variant.title | json }},
            price: {{ product.selected_or_first_available_variant.price | divided_by: 100 }},
            quantity: 1
          }]
        }
      });
    {% endif %}
  </script>
{% endunless %}


{% comment %} Integrate Klaviyo {% endcomment %}
<script type="text/javascript">
  var _learnq = _learnq || [];
  document.addEventListener('DOMContentLoaded', () => {
    _learnq.push(['track', 'Viewed Page', {
    PageName: document.title, url: window.location.href }
    ]);
  })

  {% if customer %}
    _learnq.push([
      'identify',
      {
        $email: '{{ customer.email }}',
        $first_name: '{{ customer.first_name }}',
        $last_name: '{{ customer.last_name }}',
      },
    ]);
  {% endif %}

  {% if product %}
    _learnq.push(['track', 'Viewed Product', {
      Name: {{ product.title|json }},
      ProductID: {{ product.id|json }},
      Categories: {{ product.collections|map:'title'|json }},
      ImageURL: "https:{{ product.featured_image.src|img_url:'grande' }}",
      URL: "{{ shop.secure_url }}{{ product.url }}",
      Brand: {{ product.vendor|json }},
      Price: {{ product.price|money|json }},
      CompareAtPrice: {{ product.compare_at_price_max|money|json }}
    }]);
  {% endif %}
</script>
